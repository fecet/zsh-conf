From: Claude Code Assistant
Date: Wed, 28 Aug 2025 12:00:00 +0000
Subject: [PATCH] Fix gh-r version detection using GitHub API

The current version detection for gh-r relies on parsing HTML from
GitHub releases pages, which fails due to changes in GitHub's page
structure. This patch adds GitHub API support as the primary method,
with HTML parsing as a fallback.

Changes:
- Use GitHub API (api.github.com) to get latest release version
- Fallback to original HTML parsing if API fails
- Improves reliability and performance of gh-r installations

Fixes issues where bpick patterns would fail to match any assets
due to empty version detection.

---
 zinit-install.zsh | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/zinit-install.zsh b/zinit-install.zsh
index 1234567..abcdefg 100644
--- a/zinit-install.zsh
+++ b/zinit-install.zsh
@@ -1437,7 +1437,13 @@ builtin emulate -LR zsh ${=${options[xtrace]:#off}:+-o xtrace}
   if [[ -z $urlpart ]]; then
     local tag_version=${ICE[ver]}
     if [[ -z $tag_version ]]; then
-      local releases_url=https://github.com/$user/$plugin/releases/latest
-      tag_version="$( { .zinit-download-file-stdout $releases_url || .zinit-download-file-stdout $releases_url 1; } 2>/dev/null | command grep -m1 -o 'href=./'$user'/'$plugin'/releases/tag/[^"]\+' )"
+      # Try GitHub API first, fallback to HTML parsing
+      local api_url=https://api.github.com/repos/$user/$plugin/releases/latest
+      tag_version="$( { .zinit-download-file-stdout $api_url || .zinit-download-file-stdout $api_url 1; } 2>/dev/null | command grep -o '"tag_name"[[:space:]]*:[[:space:]]*"[^"]\+"' | command grep -o '"[^"]*"$' | tr -d '"' )"
+      # Fallback to original method if API fails
+      if [[ -z $tag_version ]]; then
+        local releases_url=https://github.com/$user/$plugin/releases/latest
+        tag_version="$( { .zinit-download-file-stdout $releases_url || .zinit-download-file-stdout $releases_url 1; } 2>/dev/null | command grep -m1 -o 'href=./'$user'/'$plugin'/releases/tag/[^"]\+' )"
+      fi
       tag_version=${tag_version##*/}
     fi
     local url=https://github.com/$user/$plugin/releases/expanded_assets/$tag_version
